<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Player @8481</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0f1014;
            --bg-card: #1e222b;
            --primary: #ffffff;
            --secondary: #aeb6c4;
            --accent: #1ed760;
            --font-main: 'Inter', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* --- VIEWS --- */
        .view-container {
            flex: 1;
            overflow-y: auto;
            position: relative;
            padding-bottom: 80px; 
            scroll-behavior: smooth;
        }

        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- HOME --- */
        .home-header { padding: 20px; padding-top: 40px; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 24px; font-weight: 800; }
        .refresh-btn { background: #333; border: none; color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; }
        
        .playlist-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 0 15px 40px 15px;
        }
        .playlist-card {
            background: var(--bg-card);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .playlist-card:active { transform: scale(0.98); }
        .pc-img { width: 100%; aspect-ratio: 1/1; border-radius: 6px; object-fit: cover; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .pc-title { font-size: 14px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pc-desc { font-size: 11px; color: var(--secondary); margin-top: 2px; }

        /* Footer Credit */
        .app-credit {
            text-align: center;
            padding: 30px;
            color: #444;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- PLAYLIST DETAIL --- */
        .playlist-header-lg {
            position: relative;
            height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 20px;
            background-size: cover;
            background-position: center;
        }
        .header-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.2), var(--bg-dark));
        }
        .ph-content { position: relative; z-index: 2; }
        .back-btn {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            background: rgba(0,0,0,0.5); border: none; color: white;
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .ph-title { font-size: 28px; font-weight: 800; margin-bottom: 5px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        
        .song-list { padding: 10px 0; }
        .song-row {
            display: flex; align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
        }
        .song-row:active { background: rgba(255,255,255,0.05); }
        .sr-img { width: 45px; height: 45px; border-radius: 4px; object-fit: cover; margin-right: 15px; background: #333; }
        .sr-info { flex: 1; overflow: hidden; }
        .sr-title { font-size: 15px; font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sr-artist { font-size: 12px; color: var(--secondary); }
        .song-row.playing .sr-title { color: var(--accent); }

        /* --- MINI PLAYER --- */
        .mini-player {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: #202020; border-top: 1px solid #333;
            display: flex; align-items: center; padding: 0 15px;
            z-index: 100; transition: transform 0.3s;
            transform: translateY(100%);
        }
        .mini-player.show { transform: translateY(0); }
        .mp-img { width: 45px; height: 45px; border-radius: 4px; margin-right: 12px; object-fit: cover; }
        .mp-info { flex: 1; overflow: hidden; }
        .mp-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mp-ctrl { background: none; border: none; color: white; font-size: 22px; padding: 10px; cursor: pointer; }

        /* --- FULL PLAYER --- */
        .full-player {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #2b3546 0%, #0f1014 100%);
            z-index: 2000; padding: 25px;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .full-player.active { transform: translateY(0); }
        
        .fp-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; margin-top: 10px; }
        .fp-img-container { width: 100%; aspect-ratio: 1/1; margin-bottom: 30px; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .fp-img { width: 100%; height: 100%; object-fit: cover; }
        
        .fp-info { margin-bottom: 20px; }
        .fp-title { font-size: 24px; font-weight: 700; margin-bottom: 5px; line-height: 1.2; }
        .fp-artist { color: var(--secondary); font-size: 16px; }

        /* Custom Range Slider */
        .slider-container { width: 100%; margin-bottom: 10px; position: relative; }
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
            background-image: linear-gradient(#fff, #fff);
            background-size: 0% 100%;
            background-repeat: no-repeat;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .time-wrap { display: flex; justify-content: space-between; font-size: 12px; color: var(--secondary); margin-top: 8px; }

        .fp-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .btn-ctrl { background: none; border: none; color: white; font-size: 24px; cursor: pointer; transition: color 0.2s; }
        .btn-ctrl.active-ctrl { color: var(--accent); } 
        .btn-play-lg { width: 70px; height: 70px; background: white; color: black; border-radius: 50%; font-size: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(255,255,255,0.2); }
        
        .fp-actions { display: flex; gap: 25px; margin-top: 15px; align-items: center; }
        .heart-icon.liked { color: #e91429; } 

        /* --- OPTIONS MENU --- */
        .options-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 3000; display: none;
            justify-content: center; align-items: flex-end;
        }
        .options-menu {
            width: 100%; background: #202020;
            border-top-left-radius: 15px; border-top-right-radius: 15px;
            padding: 20px; animation: slideUp 0.3s;
        }
        .option-item {
            display: flex; align-items: center; padding: 15px 0;
            border-bottom: 1px solid #333; font-size: 16px; cursor: pointer;
        }
        .option-item i { margin-right: 15px; width: 25px; text-align: center; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Loader */
        .loader { text-align: center; margin-top: 50px; color: var(--secondary); display: none; }
        
        /* Toast Notification */
        .toast {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.9); color: black; padding: 10px 20px;
            border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 4000;
            display: none; animation: fadeUp 0.3s;
        }
        @keyframes fadeUp { from { opacity: 0; transform: translate(-50%, 10px); } to { opacity: 1; transform: translate(-50%, 0); } }
    </style>
</head>
<body>

    <div class="view-container">
        <!-- Toast -->
        <div id="toast" class="toast">Action Completed</div>

        <!-- Loading State -->
        <div id="loader" class="loader">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p style="margin-top:10px;">Syncing Database...</p>
        </div>

        <!-- 1. Home View -->
        <div id="view-home" class="screen active">
            <div class="home-header">
                <div class="page-title">Music@8481</div>
                <button class="refresh-btn" onclick="fetchData()">Sync Now <i class="fas fa-sync"></i></button>
            </div>
            <div class="playlist-grid" id="library-grid"></div>
            
            <!-- Credit Footer -->
            <div class="app-credit">
                Designed and Developed By Ayush@8481
            </div>
        </div>

        <!-- 2. Playlist View -->
        <div id="view-playlist" class="screen">
            <div class="playlist-header-lg" id="ph-bg">
                <div class="header-overlay"></div>
                <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
                <div class="ph-content">
                    <div style="font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 5px;">PLAYLIST</div>
                    <div class="ph-title" id="ph-title">Playlist Name</div>
                    <div style="font-size: 13px; color: #ccc;" id="ph-count">0 Songs</div>
                </div>
            </div>
            <div class="song-list" id="playlist-songs"></div>
        </div>
    </div>

    <!-- Mini Player -->
    <div class="mini-player" id="mini-player" onclick="openFullPlayer()">
        <img src="" class="mp-img" id="mp-img">
        <div class="mp-info">
            <div class="mp-title" id="mp-title">Song Title</div>
            <div style="font-size: 12px; color: #ccc;">@8481</div>
        </div>
        <button class="mp-ctrl" onclick="event.stopPropagation(); togglePlay()">
            <i class="fas fa-play" id="mp-play-icon"></i>
        </button>
    </div>

    <!-- Full Player Overlay -->
    <div class="full-player" id="full-player">
        <div class="fp-top">
            <button class="btn-ctrl" onclick="history.back()"><i class="fas fa-chevron-down"></i></button>
            <div style="font-size: 12px; letter-spacing: 1px; color: #ccc;">NOW PLAYING</div>
            <button class="btn-ctrl" onclick="openOptionsMenu()"><i class="fas fa-ellipsis-v"></i></button>
        </div>
        
        <div class="fp-img-container">
            <img src="" class="fp-img" id="fp-img">
        </div>

        <div class="fp-info">
            <div class="fp-title" id="fp-title">Title</div>
            <div class="fp-artist" style="margin-top:5px; color:#aeb6c4;">@8481</div>
            
            <div class="fp-actions">
                <i class="far fa-heart btn-ctrl heart-icon" id="fp-heart" onclick="toggleLike()"></i>
                <div id="offline-badge" style="display:none; color:var(--accent); font-size:12px; border:1px solid var(--accent); padding:2px 8px; border-radius:10px;">
                    <i class="fas fa-check-circle"></i> Offline
                </div>
            </div>
        </div>

        <div class="slider-container">
            <input type="range" id="seek-slider" min="0" value="0">
            <div class="time-wrap">
                <span id="curr-time">0:00</span>
                <span id="dur-time">0:00</span>
            </div>
        </div>

        <div class="fp-controls">
            <button class="btn-ctrl" id="btn-shuffle" onclick="toggleShuffle()"><i class="fas fa-random"></i></button>
            <button class="btn-ctrl" onclick="prevSong()"><i class="fas fa-step-backward"></i></button>
            <button class="btn-play-lg" onclick="togglePlay()">
                <i class="fas fa-play" id="fp-play-icon"></i>
            </button>
            <button class="btn-ctrl" onclick="nextSong()"><i class="fas fa-step-forward"></i></button>
            <button class="btn-ctrl" id="btn-loop" onclick="toggleLoop()"><i class="fas fa-retweet"></i></button>
        </div>
    </div>

    <!-- Options Menu -->
    <div class="options-overlay" id="options-menu" onclick="closeOptionsMenu(event)">
        <div class="options-menu">
            <div class="option-item" onclick="downloadCurrentSong()">
                <i class="fas fa-download"></i> Download for Offline
            </div>
            <div class="option-item" onclick="document.getElementById('options-menu').style.display='none'">
                <i class="fas fa-times"></i> Close
            </div>
        </div>
    </div>

    <script>
        // --- INDEXED DB SETUP ---
        let db;
        const DB_NAME = "MusicAppDB_8481";
        const STORE_NAME = "songs";

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains(STORE_NAME)) d.createObjectStore(STORE_NAME);
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e);
            });
        }

        async function saveBlob(url, blob) {
            if(!db) await initDB();
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).put(blob, url);
        }

        async function getBlob(url) {
            if(!db) await initDB();
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, "readonly");
                const req = tx.objectStore(STORE_NAME).get(url);
                req.onsuccess = (e) => resolve(e.target.result);
                req.onerror = () => resolve(null);
            });
        }

        // --- APP STATE ---
        let onlinePlaylists = []; // From Database
        let allPlaylists = []; // Merged
        let likedSongs = JSON.parse(localStorage.getItem('my_liked_songs')) || [];
        let downloadedSongs = JSON.parse(localStorage.getItem('my_downloaded_songs')) || [];
        
        let currentPlaylistIndex = -1;
        let currentSongIndex = 0;
        let isPlaying = false;
        let isShuffle = false;
        let isLoop = false;
        let lastPlayedTime = 0;
        
        const audio = new Audio();
        audio.preload = "auto"; 
        
        const viewHome = document.getElementById('view-home');
        const viewPlaylist = document.getElementById('view-playlist');
        const loader = document.getElementById('loader');
        const libraryGrid = document.getElementById('library-grid');
        const seekSlider = document.getElementById('seek-slider');
        const fullPlayer = document.getElementById('full-player');
        
        // --- INIT & NAVIGATION ---
        window.onload = async () => {
            await initDB();
            // Initial History State
            history.replaceState({page: 'home'}, null, '');
            fetchData();
            
            window.addEventListener('online', () => { showToast("Back Online! Syncing..."); fetchData(); });
        };

        // Handle Phone Back Button
        window.onpopstate = (event) => {
            // Logic: If Full Player is active -> Close it
            if(fullPlayer.classList.contains('active')) {
                fullPlayer.classList.remove('active');
                return;
            }
            // Logic: If Playlist is active -> Close it and show Home
            if(viewPlaylist.classList.contains('active')) {
                viewPlaylist.classList.remove('active');
                viewHome.classList.add('active');
                return;
            }
            // If on Home, browser handles exit
        };

        // --- 1. Data Fetching ---
        async function fetchData() {
            loader.style.display = 'block';
            libraryGrid.innerHTML = '';
            
            try {
                const response = await fetch('https://ayush8481-dev.github.io/Detabase/?t=' + Date.now());
                if(!response.ok) throw new Error("Network error");
                const text = await response.text();
                parseDatabase(text);
                showToast("Database Synced");
            } catch (error) {
                console.log("Offline Mode");
                showToast("Offline Mode Loaded");
                onlinePlaylists = [];
            }
            
            mergePlaylists();
            loader.style.display = 'none';
            renderHome();
        }

        function parseDatabase(text) {
            const lines = text.split('\n');
            let currentPlaylist = null;
            onlinePlaylists = []; 

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                if (line.includes('Playlist Name - "')) {
                    const nameMatch = line.match(/Playlist Name - "([^"]+)"/);
                    if (nameMatch) {
                        currentPlaylist = { name: nameMatch[1], banner: '', songs: [] };
                        onlinePlaylists.push(currentPlaylist);
                    }
                }
                else if (line.includes('Playlist Banner -')) {
                    const bannerMatch = line.match(/Playlist Banner -"([^"]+)"/);
                    if (bannerMatch && currentPlaylist) currentPlaylist.banner = bannerMatch[1];
                }
                else if (line.match(/^\d+-"/)) {
                    const songMatch = line.match(/^\d+-"([^"]+)"-"([^"]+)"/);
                    if (songMatch && currentPlaylist) {
                        const url = songMatch[1];
                        const img = songMatch[2];
                        let title = "Unknown Track";
                        try {
                            const filename = url.split('/').pop().split('?')[0];
                            title = decodeURIComponent(filename).replace(/\.mp3$/i, '').replace(/%20/g, ' ');
                        } catch (e) {}
                        currentPlaylist.songs.push({ title, url, image: img, artist: "@8481" });
                    }
                }
            });
        }

        function mergePlaylists() {
            // Favorites
            const favPlaylist = {
                name: "Favorites",
                banner: likedSongs.length ? likedSongs[0].image : "https://via.placeholder.com/300/e91429/ffffff?text=Heart",
                songs: likedSongs,
                isSpecial: true
            };
            
            // Downloads
            const dlPlaylist = {
                name: "Downloaded Songs",
                banner: downloadedSongs.length ? downloadedSongs[0].image : "https://via.placeholder.com/300/1ed760/000000?text=Offline",
                songs: downloadedSongs,
                isSpecial: true
            };

            // Order: Online First, Then Favorites, Then Downloads (Last)
            allPlaylists = [...onlinePlaylists, favPlaylist, dlPlaylist];
        }

        // --- 2. Rendering ---
        function renderHome() {
            libraryGrid.innerHTML = '';
            allPlaylists.forEach((pl, index) => {
                const card = document.createElement('div');
                card.className = 'playlist-card';
                card.onclick = () => openPlaylist(index);
                card.innerHTML = `
                    <img src="${pl.banner || 'https://via.placeholder.com/150'}" class="pc-img">
                    <div class="pc-title">${pl.name}</div>
                    <div class="pc-desc">${pl.songs.length} Songs</div>
                `;
                libraryGrid.appendChild(card);
            });
        }

        function openPlaylist(index) {
            // Push History State
            history.pushState({page: 'playlist'}, null, '');
            
            currentPlaylistIndex = index;
            const pl = allPlaylists[index];
            document.getElementById('ph-title').innerText = pl.name;
            document.getElementById('ph-bg').style.backgroundImage = `url('${pl.banner || 'https://via.placeholder.com/300'}')`;
            document.getElementById('ph-count').innerText = `${pl.songs.length} Songs`;

            const listContainer = document.getElementById('playlist-songs');
            listContainer.innerHTML = '';

            if(pl.songs.length === 0) listContainer.innerHTML = '<div style="padding:20px; color:#666; text-align:center;">No songs here yet.</div>';

            pl.songs.forEach((song, sIndex) => {
                const isDownloaded = downloadedSongs.some(d => d.url === song.url);
                const isPlayingThis = (isPlaying && currentSongIndex === sIndex && (audio.src === song.url || audio.src.startsWith("blob:")));

                const row = document.createElement('div');
                row.className = `song-row ${isPlayingThis ? 'playing' : ''}`;
                row.onclick = () => playSong(index, sIndex);
                row.innerHTML = `
                    <img src="${song.image}" class="sr-img">
                    <div class="sr-info">
                        <div class="sr-title">${song.title}</div>
                        <div class="sr-artist">@8481</div>
                    </div>
                    ${isDownloaded ? '<i class="fas fa-check-circle" style="color:var(--accent); font-size:14px;"></i>' : ''}
                `;
                listContainer.appendChild(row);
            });

            viewHome.classList.remove('active');
            viewPlaylist.classList.add('active');
            window.scrollTo(0,0);
        }

        function goHome() {
            // Simply use history.back() which triggers onpopstate
            history.back();
            // Need to re-merge to update counts if changed
            mergePlaylists();
            renderHome();
        }

        // --- 3. Audio & Offline Logic ---
        async function playSong(plIndex, sIndex) {
            const playlist = allPlaylists[plIndex];
            currentPlaylistIndex = plIndex;
            currentSongIndex = sIndex;
            const song = playlist.songs[sIndex];
            
            const offlineBlob = await getBlob(song.url);
            
            if (offlineBlob) {
                const blobUrl = URL.createObjectURL(offlineBlob);
                audio.src = blobUrl;
                document.getElementById('offline-badge').style.display = 'block';
            } else {
                audio.src = song.url;
                document.getElementById('offline-badge').style.display = 'none';
            }

            audio.play().then(() => {
                isPlaying = true;
                updatePlayerUI();
            }).catch(e => {
                if(e.name === 'NotSupportedError') showToast("Format not supported or Network error");
            });

            document.getElementById('mini-player').classList.add('show');
        }

        audio.addEventListener('error', () => {
            lastPlayedTime = audio.currentTime; 
            isPlaying = false;
            updatePlayerUI();
            showToast("Buffering/Network Issue...");
        });

        // --- 4. Controls ---
        function togglePlay() {
            if (audio.paused) {
                audio.play();
                isPlaying = true;
            } else {
                audio.pause();
                isPlaying = false;
            }
            updatePlayerUI();
        }

        function nextSong() {
            const pl = allPlaylists[currentPlaylistIndex];
            if(!pl || !pl.songs.length) return;
            if (isShuffle) currentSongIndex = Math.floor(Math.random() * pl.songs.length);
            else {
                currentSongIndex++;
                if(currentSongIndex >= pl.songs.length) currentSongIndex = 0;
            }
            playSong(currentPlaylistIndex, currentSongIndex);
        }

        function prevSong() {
            const pl = allPlaylists[currentPlaylistIndex];
            if(!pl || !pl.songs.length) return;
            currentSongIndex--;
            if(currentSongIndex < 0) currentSongIndex = pl.songs.length - 1;
            playSong(currentPlaylistIndex, currentSongIndex);
        }

        audio.addEventListener('ended', () => {
            if(isLoop) { audio.currentTime = 0; audio.play(); }
            else nextSong();
        });

        function toggleShuffle() {
            isShuffle = !isShuffle;
            document.getElementById('btn-shuffle').classList.toggle('active-ctrl', isShuffle);
            showToast(isShuffle ? "Shuffle On" : "Shuffle Off");
        }

        function toggleLoop() {
            isLoop = !isLoop;
            document.getElementById('btn-loop').classList.toggle('active-ctrl', isLoop);
            showToast(isLoop ? "Loop On" : "Loop Off");
        }

        // --- 5. Download Logic ---
        async function downloadCurrentSong() {
            const song = allPlaylists[currentPlaylistIndex].songs[currentSongIndex];
            document.getElementById('options-menu').style.display = 'none';
            showToast("Downloading...");

            try {
                const response = await fetch(song.url);
                if(!response.ok) throw new Error("Network error");
                const blob = await response.blob();
                await saveBlob(song.url, blob);
                
                if (!downloadedSongs.some(d => d.url === song.url)) {
                    downloadedSongs.push(song);
                    localStorage.setItem('my_downloaded_songs', JSON.stringify(downloadedSongs));
                }
                
                showToast("Downloaded! Available Offline.");
                document.getElementById('offline-badge').style.display = 'block';
                mergePlaylists(); // Update home counts
            } catch (e) {
                showToast("Download Failed.");
            }
        }

        // --- 6. UI Helpers ---
        function updatePlayerUI() {
            const song = allPlaylists[currentPlaylistIndex].songs[currentSongIndex];
            const iconClass = isPlaying ? 'fa-pause' : 'fa-play';
            document.getElementById('mp-play-icon').className = `fas ${iconClass}`;
            document.getElementById('fp-play-icon').className = `fas ${iconClass}`;
            document.getElementById('mp-title').innerText = song.title;
            document.getElementById('mp-img').src = song.image;
            document.getElementById('fp-title').innerText = song.title;
            document.getElementById('fp-img').src = song.image;

            const isLiked = likedSongs.some(s => s.url === song.url);
            const heartIcon = document.getElementById('fp-heart');
            if(isLiked) {
                heartIcon.classList.add('fas', 'liked');
                heartIcon.classList.remove('far');
            } else {
                heartIcon.classList.remove('fas', 'liked');
                heartIcon.classList.add('far');
            }

            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.title,
                    artist: "Ayush@8481",
                    artwork: [{ src: song.image, sizes: '512x512', type: 'image/jpeg' }]
                });
                navigator.mediaSession.setActionHandler('play', togglePlay);
                navigator.mediaSession.setActionHandler('pause', togglePlay);
                navigator.mediaSession.setActionHandler('nexttrack', nextSong);
                navigator.mediaSession.setActionHandler('previoustrack', prevSong);
            }
        }

        audio.addEventListener('timeupdate', () => {
            const curr = audio.currentTime;
            const dur = audio.duration;
            if (isNaN(dur)) return;
            seekSlider.max = dur;
            seekSlider.value = curr;
            const percentage = (curr / dur) * 100;
            seekSlider.style.backgroundSize = `${percentage}% 100%`;
            document.getElementById('curr-time').innerText = formatTime(curr);
            document.getElementById('dur-time').innerText = formatTime(dur);
        });

        seekSlider.addEventListener('input', () => {
            audio.currentTime = seekSlider.value;
            const percentage = (seekSlider.value / seekSlider.max) * 100;
            seekSlider.style.backgroundSize = `${percentage}% 100%`;
        });

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0'+sec : sec}`;
        }

        function toggleLike() {
            const song = allPlaylists[currentPlaylistIndex].songs[currentSongIndex];
            const existsIndex = likedSongs.findIndex(s => s.url === song.url);
            const heartIcon = document.getElementById('fp-heart');

            if(existsIndex > -1) {
                likedSongs.splice(existsIndex, 1);
                heartIcon.classList.remove('fas', 'liked');
                heartIcon.classList.add('far');
                showToast("Removed from Favorites");
            } else {
                likedSongs.push(song);
                heartIcon.classList.add('fas', 'liked');
                heartIcon.classList.remove('far');
                showToast("Added to Favorites");
            }
            localStorage.setItem('my_liked_songs', JSON.stringify(likedSongs));
            mergePlaylists();
        }

        function openOptionsMenu() { document.getElementById('options-menu').style.display = 'flex'; }
        function closeOptionsMenu(e) { if(e.target.id === 'options-menu') document.getElementById('options-menu').style.display = 'none'; }
        
        function openFullPlayer() { 
            history.pushState({page: 'player'}, null, '');
            fullPlayer.classList.add('active'); 
        }
        function closeFullPlayer() { 
            history.back(); // Triggers popstate
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

    </script>
</body>
</html>
